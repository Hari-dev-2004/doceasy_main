{% extends 'base.html' %}

{% block head %}
<meta name="room-id" content="{{ room.id }}">
<meta name="user-id" content="{{ current_user.id }}">
<meta name="user-name" content="{{ current_user.name }}">
<style>
    .debug-panel {
        background-color: #1a1a1a;
        color: #00ff00;
        font-family: monospace;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }
    .debug-controls {
        margin-bottom: 1rem;
    }
    .debug-log {
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .debug-log .error {
        color: #ff5555;
    }
    .debug-log .warning {
        color: #ffcc00;
    }
    .debug-log .info {
        color: #55aaff;
    }
    .debug-status {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .status-card {
        background-color: #2a2a2a;
        border-radius: 0.5rem;
        padding: 0.5rem;
        min-width: 200px;
    }
    .status-card h3 {
        margin-top: 0;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col">
    <div class="mb-4">
        <h1 class="text-2xl font-bold">WebRTC Debug - {{ room.name }}</h1>
        <div class="text-gray-500">Participants: <span id="participantsCount">{{ participants|length }}</span></div>
    </div>

    <div class="bg-white rounded-lg p-4 mb-6 shadow">
        <h2 class="text-lg font-semibold">WebRTC Connection Status</h2>
        
        <div class="debug-status">
            <div class="status-card">
                <h3>Socket.IO</h3>
                <div>Status: <span id="socketStatus">Disconnected</span></div>
                <div>Transport: <span id="socketTransport">-</span></div>
            </div>
            
            <div class="status-card">
                <h3>ICE Connection</h3>
                <div>Status: <span id="iceStatus">-</span></div>
                <div>Gathering: <span id="iceGathering">-</span></div>
            </div>
            
            <div class="status-card">
                <h3>Media</h3>
                <div>Video: <span id="videoStatus">-</span></div>
                <div>Audio: <span id="audioStatus">-</span></div>
            </div>
        </div>
        
        <div class="debug-controls">
            <button id="reconnectBtn" class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm">Force Reconnect</button>
            <button id="clearLogBtn" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm">Clear Log</button>
        </div>
        
        <div class="debug-panel">
            <div id="debugLog" class="debug-log">Initializing debug log...</div>
        </div>
    </div>

    <div class="bg-white rounded-lg p-4 mb-6 shadow">
        <h2 class="text-lg font-semibold mb-2">Connection Test</h2>
        <p class="mb-2">Test your device's network connectivity with WebRTC services:</p>
        
        <div class="flex space-x-2 mb-4">
            <button id="testSTUN" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">Test STUN</button>
            <button id="testTURN" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm">Test TURN</button>
        </div>
        
        <div class="debug-panel">
            <div id="testResults" class="debug-log">No tests run yet.</div>
        </div>
    </div>

    <div class="bg-white rounded-lg p-4 mb-6 shadow">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Video Preview</h2>
            <div class="flex space-x-2">
                <button id="toggleVideoBtn" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Toggle Video</button>
                <button id="toggleAudioBtn" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Toggle Audio</button>
            </div>
        </div>
        <div class="video-grid" id="videoGrid">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-name">You ({{ current_user.name }})</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/webrtc.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomId = document.querySelector('meta[name="room-id"]').getAttribute('content');
    const userId = document.querySelector('meta[name="user-id"]').getAttribute('content');
    const userName = document.querySelector('meta[name="user-name"]').getAttribute('content');
    const debugLog = document.getElementById('debugLog');
    const testResults = document.getElementById('testResults');
    
    // Debug logging
    function addDebugLog(message, type = 'normal') {
        const time = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${time}] ${message}`;
        if (type !== 'normal') {
            logEntry.classList.add(type);
        }
        debugLog.appendChild(logEntry);
        debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    // Override console logging
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;
    
    console.log = function() {
        addDebugLog(Array.from(arguments).join(' '), 'info');
        originalConsoleLog.apply(console, arguments);
    }
    
    console.error = function() {
        addDebugLog(Array.from(arguments).join(' '), 'error');
        originalConsoleError.apply(console, arguments);
    }
    
    console.warn = function() {
        addDebugLog(Array.from(arguments).join(' '), 'warning');
        originalConsoleWarn.apply(console, arguments);
    }
    
    // WebRTC test functions
    document.getElementById('testSTUN').addEventListener('click', async function() {
        testResults.textContent = 'Testing STUN servers...';
        
        const servers = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun.stunprotocol.org:3478' }
        ];
        
        let results = [];
        
        for (const server of servers) {
            try {
                testResults.textContent += `\nTesting ${server.urls}...`;
                const pc = new RTCPeerConnection({ iceServers: [server] });
                
                // Create a data channel to trigger ICE gathering
                pc.createDataChannel('test');
                
                // Create an offer to trigger ICE gathering
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                // Wait for ICE gathering to complete or timeout
                const success = await new Promise((resolve) => {
                    const timeout = setTimeout(() => resolve(false), 5000);
                    
                    pc.addEventListener('icecandidate', (e) => {
                        if (!e.candidate) return;
                        
                        if (e.candidate.candidate.indexOf('srflx') !== -1) {
                            clearTimeout(timeout);
                            resolve(true);
                        }
                    });
                });
                
                results.push({
                    server: server.urls,
                    success: success,
                    publicIP: success ? 'Found' : 'Not found'
                });
                
                pc.close();
                
                testResults.textContent += success ? ' SUCCESS' : ' FAILED';
            } catch (err) {
                results.push({
                    server: server.urls,
                    success: false,
                    error: err.message
                });
                testResults.textContent += ` ERROR: ${err.message}`;
            }
        }
        
        testResults.textContent += '\n\nSTUN Test Results:';
        results.forEach(result => {
            testResults.textContent += `\n${result.server}: ${result.success ? 'SUCCESS' : 'FAILED'}`;
        });
    });
    
    document.getElementById('testTURN').addEventListener('click', async function() {
        testResults.textContent = 'Testing TURN server...';
        
        try {
            const server = { 
                urls: 'turn:numb.viagenie.ca',
                username: 'webrtc@live.com',
                credential: 'muazkh'
            };
            
            testResults.textContent += `\nTesting ${server.urls}...`;
            
            const pc = new RTCPeerConnection({ iceServers: [server] });
            
            // Create a data channel
            pc.createDataChannel('test');
            
            // Create an offer
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            // Wait for relay candidate or timeout
            const success = await new Promise((resolve) => {
                const timeout = setTimeout(() => resolve(false), 8000);
                
                pc.addEventListener('icecandidate', (e) => {
                    if (!e.candidate) return;
                    
                    if (e.candidate.candidate.indexOf('relay') !== -1) {
                        clearTimeout(timeout);
                        resolve(true);
                    }
                });
            });
            
            pc.close();
            
            testResults.textContent += success ? ' SUCCESS' : ' FAILED';
            testResults.textContent += '\n\nTURN Test Result: ' + (success ? 'SUCCESS' : 'FAILED');
        } catch (err) {
            testResults.textContent += ` ERROR: ${err.message}`;
            testResults.textContent += '\n\nTURN Test Result: FAILED';
        }
    });
    
    // Button handlers
    document.getElementById('reconnectBtn').addEventListener('click', function() {
        addDebugLog('Manually triggering reconnection', 'warning');
        if (window.reconnectAllPeers) {
            window.reconnectAllPeers();
        }
    });
    
    document.getElementById('clearLogBtn').addEventListener('click', function() {
        debugLog.innerHTML = '';
        addDebugLog('Log cleared', 'info');
    });
    
    // Initialize WebRTC
    try {
        addDebugLog('Initializing WebRTC...', 'info');
        window.initWebRTC(roomId, userId, userName);
    } catch (err) {
        addDebugLog(`Error initializing WebRTC: ${err.message}`, 'error');
    }
});
</script>
{% endblock %} 